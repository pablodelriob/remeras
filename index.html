<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor de Remeras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Dise√±√° remeras personalizadas con nuestro editor interactivo.">
   <!-- üé® Estilos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/jquery.miniColors.css" rel="stylesheet">

  <!-- üñåÔ∏è Estilos personalizados -->
  <style>
    body {
      padding-top: 60px;
      background-color: #f9f9f9;
    }

    .footer {
      padding: 70px 0;
      margin-top: 70px;
      border-top: 1px solid #E5E5E5;
      background-color: #f5f5f5;
    }

    .color-preview {
      border: 1px solid #ccc;
      margin: 2px;
      vertical-align: top;
      display: inline-block;
      cursor: pointer;
      width: 20px;
      height: 20px;
    }

    .rotate {
      transform: rotate(90deg);
    }

    /* üéØ Fuentes personalizadas */
    .Arial{font-family: "Arial";}
    .Helvetica{font-family: "Helvetica";}
    .MyriadPro{font-family: "Myriad Pro";}
    .Delicious{font-family: "Delicious";}
    .Verdana{font-family: "Verdana";}
    .Georgia{font-family: "Georgia";}
    .Courier{font-family: "Courier";}
    .ComicSansMS{font-family: "Comic Sans MS";}
    .Impact{font-family: "Impact";}
    .Monaco{font-family: "Monaco";}
    .Optima{font-family: "Optima";}
    .HoeflerText{font-family: "Hoefler Text";}
    .Plaster{font-family: "Plaster";}
    .Engagement{font-family: "Engagement";}
  </style>

  <!-- ‚öôÔ∏è Librer√≠as -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
</head>


  <body class="preview">

  <div class="container">
    <section id="editor">
      <div class="page-header">
        <h1>Dise√±ador de Remeras</h1>
      </div>

      <div class="row">
        <!-- üé® Panel izquierdo: Opciones -->
        <div class="col-md-3">
          <div class="card mb-3">
            <div class="card-header">Opciones de Remera</div>
            <div class="card-body">
              <select id="tshirttype" class="form-control mb-3">
                <option value="img/crew_front.png" selected>Remera manga corta</option>
                <option value="img/mens_longsleeve_front.png">Manga larga</option>
                <option value="img/mens_hoodie_front.png">Buzo</option>
                <option value="img/mens_tank_front.png">Musculosa</option>
              </select>

              <div id="colorPalette" class="d-flex flex-wrap">
                <div class="color-preview" style="background-color:#ffffff;" title="Blanco"></div>
                <div class="color-preview" style="background-color:#222222;" title="Negro"></div>
                <div class="color-preview" style="background-color:#fc8d74;" title="Naranja"></div>
                <div class="color-preview" style="background-color:#1f6522;" title="Verde"></div>
                <div class="color-preview" style="background-color:#15aeda;" title="Celeste"></div>
                <div class="color-preview" style="background-color:#c50404;" title="Rojo"></div>
              </div>
            </div>
          </div>

          <div class="card mb-3">
            <div class="card-header">Im√°genes y Avatares</div>
            <div class="card-body">
              <input type="text" id="text-string" class="form-control mb-2" placeholder="Agregar texto">
              <button id="add-text" class="btn btn-secondary btn-block mb-3">Agregar texto</button>

              <div id="avatarlist" class="d-flex flex-wrap">
                <img class="img-thumbnail m-1 img-polaroid" src="img/invisibleman.jpg" style="cursor:pointer;">
                <img class="img-thumbnail m-1 img-polaroid" src="img/invisibleman.jpg" style="cursor:pointer;">
              </div>

              <hr>
              <form id="uploadForm">
                <input type="file" name="fileToUpload" id="fileToUpload" class="form-control mb-2" accept="image/*">
                <input type="submit" value="Subir Imagen" class="btn btn-primary btn-block">
              </form>
            </div>
          </div>
        </div>

        <!-- üëï √Årea central: Editor de dise√±o -->
        <div class="col-md-6">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div id="texteditor" class="btn-group" style="display:none;">
              <!-- Botones de edici√≥n de texto aqu√≠ -->
            </div>
            <div id="imageeditor" class="btn-group" style="display:none;">
              <!-- Botones de edici√≥n de imagen aqu√≠ -->
              <button id="flipback" class="btn btn-info" title="Cambiar vista"><i class="icon-retweet"></i></button>
              <button id="remove-selected" class="btn btn-danger" title="Eliminar selecci√≥n"><i class="icon-trash"></i></button>
            </div>
          </div>

          <div id="shirtDiv" class="position-relative" style="width: 530px; height: 630px; background-color: #fff;">
            <img name="tshirtview" id="tshirtFacing" src="img/crew_front.png" class="img-fluid">
            <div id="drawingArea" style="position: absolute; top: 100px; left: 160px; width: 200px; height: 400px; z-index: 10;">
              <canvas id="tcanvas" width="200" height="400" class="hover"></canvas>
            </div>
          </div>
        </div>

        <!-- üì¶ Panel derecho: Talles -->
        <div class="col-md-3">
          <div class="card">
            <div class="card-header">Seleccionar talles</div>
            <div class="card-body">
              <table class="table table-sm">
                <tr><td><input type="checkbox" name="S"> S</td><td><input type="number" name="cantidad_S" min="0" class="form-control"></td></tr>
                <tr><td><input type="checkbox" name="M"> M</td><td><input type="number" name="cantidad_M" min="0" class="form-control"></td></tr>
                <tr><td><input type="checkbox" name="L"> L</td><td><input type="number" name="cantidad_L" min="0" class="form-control"></td></tr>
                <tr><td><input type="checkbox" name="XL"> XL</td><td><input type="number" name="cantidad_XL" min="0" class="form-control"></td></tr>
                <tr><td><input type="checkbox" name="XXL"> XXL</td><td><input type="number" name="cantidad_XXL" min="0" class="form-control"></td></tr>
              </table>
              <button type="button" id="addToTheBag" class="btn btn-success btn-block">Agregar al pedido <i class="icon-briefcase"></i></button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
				  		
<!-- üßæ Modal para datos del cliente -->
<div class="modal fade" id="clientModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <form id="clientForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Datos del Cliente y Pedido</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label for="nombre_cliente">Nombre</label>
            <input type="text" class="form-control" name="nombre_cliente" id="nombre_cliente" required>
          </div>

          <div class="form-group">
            <label for="telefono_cliente">Tel√©fono</label>
            <input type="text" class="form-control" name="telefono_cliente" id="telefono_cliente" required>
          </div>

          <div class="form-group">
            <label for="ciudad_cliente">Ciudad</label>
            <input type="text" class="form-control" name="ciudad_cliente" id="ciudad_cliente" required>
          </div>

          <div class="form-group">
            <label for="descripcion_cliente">Descripci√≥n breve</label>
            <textarea class="form-control" name="descripcion_cliente" id="descripcion_cliente" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="detalles_remeras_clientes">Detalles del pedido</label>
            <textarea class="form-control" name="detalles_remeras_clientes" id="detalles_remeras_clientes" readonly></textarea>
          </div>

          <div class="form-group">
            <label for="imagen_dise√±o">Dise√±o generado</label>
            <img id="imagen_dise√±o_preview" src="" class="img-fluid mb-2 border" alt="Vista previa">
            <input type="file" name="imagen_dise√±o" id="imagen_dise√±o" style="display:none;" accept="image/png,image/jpeg">
            <canvas id="previewCanvas" width="500" height="500" style="display:none;"></canvas>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Enviar Pedido</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
// üì¶ Utilidades
function dataURItoBlob(dataURI) {
  const byteString = atob(dataURI.split(',')[1]);
  const mimeType = dataURI.split(',')[0].split(':')[1].split(';')[0];
  const ab = new ArrayBuffer(byteString.length);
  const ia = new Uint8Array(ab);
  for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
  return new Blob([ab], { type: mimeType });
}

// üëï Cambio de vista (frente/dorso) seg√∫n estilo seleccionado
function intercambiarVista(frente, dorso) {
  const modo = $("#flipback").attr("data-original-title");
  const imagen = modo === "Show Back View" ? dorso : frente;
  const json = modo === "Show Back View" ? b : a;

  $("#flipback").attr("data-original-title", modo === "Show Back View" ? "Show Front View" : "Show Back View");
  $("#tshirtFacing").attr("src", imagen);
  if (modo === "Show Back View") a = JSON.stringify(canvas); else b = JSON.stringify(canvas);

  canvas.clear();
  try { canvas.loadFromJSON(json); } catch (e) {}
  canvas.renderAll();
  setTimeout(() => canvas.calcOffset(), 200);
}

// üßµ Captura de talles y activaci√≥n del modal
$("#addToTheBag").click(function () {

  const talles = [];
  $(".table tr").each(function () {
    const check = $(this).find("input[type='checkbox']");
    const input = $(this).find("input[type='number']");
    if (check.prop("checked") && input.val() > 0) {
      talles.push(`${$(this).text().trim()}: ${input.val()}`);
    }
  });
  $("#detalles_remeras_clientes").val(talles.join('\n'));

  const previewData = canvas.toDataURL("image/png");
  $("#imagen_dise√±o_preview").attr("src", previewData);
  $("#clientModal").modal("show");
});

// üì§ Env√≠o del formulario via AJAX
$("#clientForm").submit(function (e) {
  e.preventDefault();
  const idPedido = Date.now();
  const dise√±oBlob = dataURItoBlob(canvas.toDataURL({ format: "png" }));
  const dise√±oFile = new File([dise√±oBlob], idPedido + ".png", { type: "image/png" });

  const formData = new FormData();
  formData.append("id_pedido", idPedido);
  formData.append("nombre_cliente", $("#nombre_cliente").val());
  formData.append("telefono_cliente", $("#telefono_cliente").val());
  formData.append("ciudad_cliente", $("#ciudad_cliente").val());
  formData.append("descripcion_cliente", $("#descripcion_cliente").val());
  formData.append("detalles_remeras_clientes", $("#detalles_remeras_clientes").val());
  formData.append("imagen_dise√±o", dise√±oFile);

  $.ajax({
    url: "guardar_pedido.php",
    method: "POST",
    data: formData,
    processData: false,
    contentType: false,
    success: function () {
      alert("‚úÖ Pedido enviado correctamente");
      $("#clientModal").modal("hide");
      $("#clientForm")[0].reset();
    },
    error: function (xhr) {
      alert("‚ùå Error al enviar el pedido");
      console.error(xhr.responseText);
    }
  });
});

// üéΩ Cambiar imagen frontal seg√∫n estilo de remera
$("#tshirttype").change(function () {
  $("img[name='tshirtview']").attr("src", $(this).val());
});

// üîÑ Rotaci√≥n entre vistas segun estilo seleccionado
let valueSelect = $("#tshirttype").val();
$("#tshirttype").on("change", function () {
  valueSelect = $(this).val();
});

$("#flipback").click(function () {
  const mapaVistas = {
    "img/crew_front.png": "img/crew_back.png",
    "img/mens_longsleeve_front.png": "img/mens_longsleeve_back.png",
    "img/mens_hoodie_front.png": "img/mens_hoodie_back.png",
    "img/mens_tank_front.png": "img/mens_tank_back.png"
  };

  const actual = $("#tshirttype").val(); // ‚úÖ Obtiene el valor din√°micamente
  const dorso = mapaVistas[actual] || "img/crew_back.png";
  intercambiarVista(actual, dorso);
});


$(".color-preview").click(function () {
  const color = $(this).css("background-color");
  $("#shirtDiv").css("background-color", color);
});

</script>

<!-- üîß Cierre con librer√≠as -->
<script src="js/bootstrap.min.js"></script>
<script src="js/tshirtEditor.js"></script>
<script src="js/jquery.miniColors.min.js"></script>
   
  </body>
</html>